<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Gestor de Listas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/css/dashboard.css">
    <style>
        .tachado {
            text-decoration: line-through;
            color: #aaa;
        }

        .card-lista {
            border-top: 4px solid var(--primary);
            transition: transform 0.2s;
        }

        .card-lista:hover {
            transform: translateY(-3px);
        }

        .historial-section {
            opacity: 0.8;
        }

        .badge-fecha {
            font-size: 0.75rem;
            font-weight: normal;
            background: #eee;
            color: #555;
            padding: 4px 8px;
            border-radius: 6px;
        }
    </style>
</head>

<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <h3>AYS SOFTWARE</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/"><i class="fa-solid fa-magnifying-glass"></i> Buscar Productos</a></li>
            <li><a href="/modificar"><i class="fa-solid fa-pen-to-square"></i> Modificar</a></li>
            <li><a href="/agregar"><i class="fa-solid fa-circle-plus"></i> Agregar Producto</a></li>
            <li><a href="/duplicados"><i class="fa-solid fa-clone"></i> Duplicados</a></li>
            <li><a href="/eliminar-menu"><i class="fa-solid fa-trash-can"></i> Eliminar</a></li>
            <li><a href="/lista" class="active"><i class="fa-solid fa-clipboard-list"></i> Lista Almacén</a></li>
            <li style="margin-top: 40px;"><a href="/logout" class="text-danger"><i
                        class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión</a></li>
        </ul>
    </nav>
    <button class="menu-toggle-btn" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i
            class="fa-solid fa-bars"></i></button>

    <div class="main-content">

        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <div>
                <h2 class="fw-bold text-dark m-0">Gestión de Pedidos</h2>
                <p class="text-muted mb-0 small">Crea listas separadas por persona o área.</p>
            </div>

            <button onclick="crearLista()" class="btn btn-primary shadow-sm">
                <i class="fa-solid fa-plus me-2"></i> Nueva Lista
            </button>
        </div>

        <% if(listasHoy.length===0) { %>
            <div class="text-center py-5">
                <div class="mb-3 text-muted"><i class="fa-solid fa-clipboard-list fa-3x opacity-25"></i></div>
                <h5 class="text-muted fw-normal">No hay listas creadas para hoy.</h5>
                <button onclick="crearLista()" class="btn btn-sm btn-outline-primary mt-2">Crear la primera</button>
            </div>
            <% } %>

                <div class="row g-4 mb-5">
                    <% listasHoy.forEach(lista=> { %>
                        <div class="col-md-6 col-lg-4">
                            <div class="card card-lista shadow-sm h-100">
                                <div
                                    class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-bottom-0">
                                    <h5 class="fw-bold m-0 text-primary"><i class="fa-solid fa-user-pen me-2"></i>
                                        <%= lista.nombre_lista %>
                                    </h5>
                                    <a href="/api/listas/eliminar/<%= lista.id %>" class="btn btn-sm text-danger p-0"
                                        onclick="return confirm('¿Borrar toda la lista de <%= lista.nombre_lista %>?')"
                                        title="Eliminar Lista">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </a>
                                </div>

                                <div class="card-body p-3 pt-0">
                                    <form action="/api/items/agregar" method="POST" class="mb-3">
                                        <input type="hidden" name="lista_id" value="<%= lista.id %>">
                                        <div class="input-group">
                                            <input type="text" name="texto"
                                                class="form-control form-control-sm bg-light border-0"
                                                placeholder="Agregar producto..." required autocomplete="off">
                                            <button class="btn btn-sm btn-dark"><i
                                                    class="fa-solid fa-plus"></i></button>
                                        </div>
                                    </form>

                                    <ul class="list-group list-group-flush">
                                        <% if(lista.items.length===0) { %>
                                            <li
                                                class="list-group-item text-center text-muted small border-0 fst-italic">
                                                Lista vacía</li>
                                            <% } %>
                                                <% lista.items.forEach(item=> { %>
                                                    <li
                                                        class="list-group-item d-flex justify-content-between align-items-center px-0 py-2 border-bottom-0">
                                                        <span onclick="toggleItem('<%= item.id %>', this)"
                                                            style="cursor:pointer"
                                                            class="<%= item.completado ? 'tachado' : '' %> flex-grow-1">
                                                            <i
                                                                class="fa-regular <%= item.completado ? 'fa-square-check text-success' : 'fa-square text-muted' %> me-2"></i>
                                                            <%= item.texto %>
                                                        </span>
                                                        <a href="/api/items/eliminar/<%= item.id %>"
                                                            class="text-danger small ms-2"><i
                                                                class="fa-solid fa-xmark"></i></a>
                                                    </li>
                                                    <% }) %>
                                    </ul>
                                </div>
                                <div class="card-footer bg-white border-0 text-muted small text-end pt-0">
                                    <span class="badge-fecha">Hoy</span>
                                </div>
                            </div>
                        </div>
                        <% }) %>
                </div>

                <% if(listasHistorial.length> 0) { %>
                    <hr class="my-5">
                    <h4 class="fw-bold text-muted mb-4"><i class="fa-solid fa-clock-rotate-left me-2"></i> Historial
                        (Días Anteriores)</h4>

                    <div class="row g-4 opacity-75">
                        <% listasHistorial.forEach(lista=> { %>
                            <div class="col-md-6 col-lg-4">
                                <div class="card shadow-sm h-100 border-0 bg-light">
                                    <div
                                        class="card-header bg-transparent d-flex justify-content-between align-items-center">
                                        <strong class="text-dark">
                                            <%= lista.nombre_lista %>
                                        </strong>
                                        <span class="badge-fecha">
                                            <%= new Date(lista.fecha).toLocaleDateString('es-PE') %>
                                        </span>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0 small text-muted">
                                            <% lista.items.forEach(item=> { %>
                                                <li class="mb-1">
                                                    <i class="fa-solid fa-check text-success me-1"
                                                        style="font-size:0.7rem"></i>
                                                    <%= item.texto %>
                                                </li>
                                                <% }) %>
                                                    <% if(lista.items.length===0) { %>
                                                        <li>(Sin ítems)</li>
                                                        <% } %>
                                        </ul>
                                    </div>
                                    <div class="card-footer bg-transparent border-0 text-end">
                                        <a href="/api/listas/eliminar/<%= lista.id %>"
                                            class="text-danger small text-decoration-none"
                                            onclick="return confirm('¿Borrar del historial?')">Eliminar
                                            Definitivamente</a>
                                    </div>
                                </div>
                            </div>
                            <% }) %>
                    </div>
                    <% } %>

    </div>

    <script>
        // SweetAlert para crear nueva lista bonita
        async function crearLista() {
            const { value: nombre } = await Swal.fire({
                title: 'Nueva Lista de Pedido',
                input: 'text',
                inputLabel: 'Nombre de la persona o área (Ej: Walter)',
                inputPlaceholder: 'Escribe el nombre...',
                showCancelButton: true,
                confirmButtonText: 'Crear Lista',
                inputValidator: (value) => {
                    if (!value) {
                        return '¡Necesitas escribir un nombre!'
                    }
                }
            });

            if (nombre) {
                // Crear formulario invisible y enviarlo
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/api/listas/crear';
                const input = document.createElement('input');
                input.name = 'nombre_lista';
                input.value = nombre;
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Tachar ítem
        function toggleItem(id, elemento) {
            const span = elemento;
            const icon = span.querySelector('i');

            if (span.classList.contains('tachado')) {
                span.classList.remove('tachado');
                icon.className = 'fa-regular fa-square text-muted me-2';
            } else {
                span.classList.add('tachado');
                icon.className = 'fa-regular fa-square-check text-success me-2';
            }
            fetch('/api/items/toggle/' + id, { method: 'POST' }).catch(console.error);
        }
    </script>
</body>

</html>