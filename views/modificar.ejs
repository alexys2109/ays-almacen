<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modificar Productos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css" />
    <link rel="stylesheet" href="/css/dashboard.css">
    
    <style>
        #nprogress .bar { background: var(--primary) !important; height: 4px !important; }
        body.loading { cursor: wait; }
        .fila-producto { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #sentinel { height: 20px; width: 100%; margin-top: 20px; }
        .loader-scroll { text-align: center; color: var(--text-muted); display: none; padding: 20px; }
        .loader-scroll.active { display: block; }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header"><h3>AYS SOFTWARE</h3></div>
        <ul class="sidebar-menu">
            <li><a href="/"><i class="fa-solid fa-magnifying-glass"></i> Buscar Productos</a></li>
            <li><a href="/modificar" class="active"><i class="fa-solid fa-pen-to-square"></i> Modificar</a></li>
            <li><a href="/agregar"><i class="fa-solid fa-circle-plus"></i> Agregar Producto</a></li>
            <li><a href="/duplicados"><i class="fa-solid fa-clone"></i> Duplicados</a></li>
            <li><a href="/eliminar-menu"><i class="fa-solid fa-trash-can"></i> Eliminar</a></li>
            <li><a href="/lista"><i class="fa-solid fa-clipboard-list"></i> Lista Almacén</a></li>
            <li style="margin-top: 40px;"><a href="/logout" class="text-danger"><i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesión</a></li>
        </ul>
    </nav>
    <button class="menu-toggle-btn" onclick="document.querySelector('.sidebar').classList.toggle('active')"><i class="fa-solid fa-bars"></i></button>

    <div class="main-content">
        <h2 class="fw-bold text-warning mb-4">Modificar Inventario</h2>
        
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body py-3">
                <div class="row g-2 align-items-center">
                    
                    <div class="col-12 col-md-6">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                            <input type="text" id="inputBusqueda" class="form-control border-start-0" placeholder="Escribe para buscar..." autocomplete="off">
                        </div>
                    </div>

                    <div class="col-8 col-md-4">
                        <select id="selectCategoria" class="form-select">
                            <option value="">-- Todas --</option>
                            <% categorias.forEach(c => { %>
                                <option value="<%= c.id %>"><%= c.nombre %></option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="col-4 col-md-2">
                        <button id="btnReset" class="btn btn-outline-secondary w-100" title="Limpiar"><i class="fa-solid fa-rotate-left"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm bg-transparent">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table align-middle mb-0 tabla-edicion">
                        <thead class="table-light text-center">
                            <tr>
                                <th>Nombre</th> <th>Compra</th> <th>Mayor</th> <th>Unidad</th> <th>Categoría</th> <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tablaBody">
                            </tbody>
                    </table>
                </div>

                <div id="loader" class="loader-scroll">
                    <i class="fa-solid fa-spinner fa-spin fa-lg"></i> Cargando...
                </div>
                
                <div id="sentinel"></div>
            </div>
        </div>
    </div>

    <script>
        // Guardamos las categorías para reconstruir el select dinámicamente
        const listaCategorias = <%- JSON.stringify(categorias) %>;
    </script>

    <script>
        let pagina = 1;
        let busqueda = '';
        let categoria = '';
        let cargando = false;
        let finDeDatos = false;
        let timeoutBusqueda; // Para el "freno de mano"

        const inputBusqueda = document.getElementById('inputBusqueda');
        const selectCategoria = document.getElementById('selectCategoria');
        const btnReset = document.getElementById('btnReset');
        const tablaBody = document.getElementById('tablaBody');
        const loader = document.getElementById('loader');

        // --- FUNCIÓN PRINCIPAL: TRAER DATOS DEL SERVIDOR ---
        async function fetchProductos(reset = false) {
            if (cargando) return;
            if (reset) {
                pagina = 1;
                finDeDatos = false;
                tablaBody.innerHTML = ''; // Limpiamos tabla
                loader.innerHTML = '<i class="fa-solid fa-spinner fa-spin fa-lg"></i> Buscando...';
                loader.classList.add('active');
            } else {
                if (finDeDatos) return;
                pagina++;
                loader.innerHTML = '<i class="fa-solid fa-spinner fa-spin fa-lg"></i> Cargando más...';
                loader.classList.add('active');
            }

            cargando = true;

            try {
                // LLAMADA MÁGICA A LA API
                const url = `/api/productos?page=${pagina}&busqueda=${encodeURIComponent(busqueda)}&categoria=${categoria}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.length === 0) {
                    finDeDatos = true;
                    if (reset) {
                        tablaBody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted">No se encontraron productos.</td></tr>';
                        loader.classList.remove('active');
                    } else {
                        loader.innerHTML = '<span class="text-muted small">Fin de los resultados</span>';
                    }
                } else {
                    // DIBUJAR FILAS
                    renderizarFilas(data);
                    loader.classList.remove('active');
                }
            } catch (error) {
                console.error(error);
                loader.innerText = 'Error de conexión';
            }
            cargando = false;
        }

        // --- DIBUJAR HTML ---
        function renderizarFilas(productos) {
            let html = '';
            productos.forEach(p => {
                const opcionesCat = listaCategorias.map(c => 
                    `<option value="${c.id}" ${p.categoria_id == c.id ? 'selected' : ''}>${c.nombre}</option>`
                ).join('');

                html += `
                    <tr class="fila-producto">
                        <form id="form-${p.id}" action="/modificar/guardar/${p.id}" method="POST"></form>
                        <td data-label="Nombre"><textarea name="nombre" class="form-control input-nombre" form="form-${p.id}" required rows="1">${p.nombre}</textarea></td>
                        <td data-label="P. Compra"><input type="number" step="0.01" name="precio_compra" class="form-control text-secondary" value="${p.precio_compra}" form="form-${p.id}"></td>
                        <td data-label="P. Mayor"><input type="number" step="0.01" name="precio_mayor" class="form-control fw-bold text-primary" value="${p.precio_mayor}" form="form-${p.id}"></td>
                        <td data-label="P. Unidad"><input type="number" step="0.01" name="precio_unidad" class="form-control fw-bold text-success" value="${p.precio_unidad}" form="form-${p.id}"></td>
                        <td data-label="Categoría">
                            <select name="categoria_id" class="form-select" form="form-${p.id}">
                                <option value="">-- Sin Categ. --</option>
                                ${opcionesCat}
                            </select>
                        </td>
                        <td data-label="Guardar">
                            <button type="submit" class="btn btn-warning w-100 shadow-sm" form="form-${p.id}"><i class="fa-solid fa-floppy-disk me-2"></i> Guardar</button>
                        </td>
                    </tr>
                `;
            });
            tablaBody.insertAdjacentHTML('beforeend', html);
        }

        // --- EVENTOS INTELIGENTES ---

        // 1. Escribir en el buscador (Con Freno de Mano / Debounce)
        inputBusqueda.addEventListener('input', (e) => {
            busqueda = e.target.value.trim();
            clearTimeout(timeoutBusqueda); // Cancelamos búsqueda anterior
            
            // Esperamos 400ms a que termines de escribir
            timeoutBusqueda = setTimeout(() => {
                fetchProductos(true); // Buscar desde cero
            }, 400);
        });

        // 2. Cambiar Categoría
        selectCategoria.addEventListener('change', (e) => {
            categoria = e.target.value;
            fetchProductos(true);
        });

        // 3. Botón Limpiar
        btnReset.addEventListener('click', () => {
            inputBusqueda.value = '';
            selectCategoria.value = '';
            busqueda = '';
            categoria = '';
            fetchProductos(true);
        });

        // 4. Scroll Infinito (Observer)
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) {
                fetchProductos(false); // Cargar MÁS (no resetear)
            }
        }, { rootMargin: '200px' }); // Cargar antes de llegar al final

        const sentinel = document.getElementById('sentinel');
        if (sentinel) observer.observe(sentinel);

        // 5. Carga Inicial
        fetchProductos(true);

        // Barra NProgress (Visual)
        NProgress.configure({ showSpinner: false });
        document.addEventListener('submit', (e) => {
            if(e.target.tagName === 'FORM') NProgress.start();
        });
    </script>
</body>
</html>
